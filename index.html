<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student QR Generator with GPS</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 400px;
        margin: 30px auto;
        padding: 0 15px;
      }
      label {
        display: block;
        margin-top: 15px;
      }
      input {
        width: 100%;
        padding: 8px;
        font-size: 16px;
      }
      button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }
      #qr {
        margin-top: 30px;
        text-align: center;
      }
      #status {
        margin-top: 15px;
        font-style: italic;
        color: #555;
      }
    </style>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0d6efd" />
  </head>
  <body>
    <h2>Student QR Generator</h2>

    <div id="inputForm" style="display: none">
      <label for="nameInput">Full Name:</label>
      <input type="text" id="nameInput" placeholder="Juan Dela Cruz" />

      <label for="idInput">ID Number:</label>
      <input type="text" id="idInput" placeholder="123456" />

      <button id="saveBtn">Save & Generate QR</button>
    </div>

    <div id="qrSection" style="display: none">
      <canvas id="qr"></canvas>
      <div id="status"></div>
      <button id="resetBtn">Reset / Change Info</button>
    </div>

    <script>
      const nameKey = "studentName";
      const idKey = "studentId";

      function showInputForm() {
        document.getElementById("inputForm").style.display = "block";
        document.getElementById("qrSection").style.display = "none";
      }

      function showQRSection() {
        document.getElementById("inputForm").style.display = "none";
        document.getElementById("qrSection").style.display = "block";
      }

      function generateQRCode(name, id, lat, lng) {
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
        const timestamp = now.getTime();

        const data = {
          name: name,
          id: id,
          date: dateStr,
          timestamp: timestamp,
          lat: lat,
          lng: lng,
        };

        const jsonData = JSON.stringify(data);

        const canvas = document.getElementById("qr");
        QRCode.toCanvas(canvas, jsonData, { width: 250 }, (err) => {
          if (err) {
            document.getElementById("status").textContent =
              "Error generating QR code.";
            console.error(err);
          } else {
            document.getElementById(
              "status"
            ).textContent = `QR generated at ${now.toLocaleTimeString()}`;
          }
        });
      }

      function requestLocationAndGenerateQR(name, id) {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }

        document.getElementById("status").textContent =
          "Getting your location...";

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            // Validate lat/lng are numbers
            if (
              typeof lat !== "number" ||
              typeof lng !== "number" ||
              isNaN(lat) ||
              isNaN(lng)
            ) {
              alert("Could not get valid location coordinates.");
              document.getElementById("status").textContent =
                "Invalid location data.";
              return;
            }

            generateQRCode(name, id, lat, lng);
          },
          (err) => {
            alert(
              "Location permission denied or unavailable. Please allow location access and try again."
            );
            document.getElementById("status").textContent =
              "Location access denied.";
          },
          { enableHighAccuracy: true, timeout: 15000 }
        );
      }

      window.onload = () => {
        const storedName = localStorage.getItem(nameKey);
        const storedId = localStorage.getItem(idKey);

        if (storedName && storedId) {
          showQRSection();
          requestLocationAndGenerateQR(storedName, storedId);
        } else {
          showInputForm();
        }
      };

      document.getElementById("saveBtn").onclick = () => {
        const name = document.getElementById("nameInput").value.trim();
        const id = document.getElementById("idInput").value.trim();

        if (!name || !id) {
          alert("Please enter both your name and ID number.");
          return;
        }

        localStorage.setItem(nameKey, name);
        localStorage.setItem(idKey, id);

        showQRSection();
        requestLocationAndGenerateQR(name, id);
      };

      document.getElementById("resetBtn").onclick = () => {
        localStorage.removeItem(nameKey);
        localStorage.removeItem(idKey);
        document
          .getElementById("qr")
          .getContext("2d")
          .clearRect(0, 0, 250, 250);
        document.getElementById("status").textContent = "";
        showInputForm();
      };

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").then(() => {
            console.log("Service Worker registered!");
          });
        });
      }
    </script>
  </body>
</html>